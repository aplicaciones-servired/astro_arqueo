---
import HeaderLink from "./HeaderLink.astro";
import "../../styles/global.css";
import EmpresaSelector from "../ui/EmpresaSelector";
import { SignedIn, UserButton } from "@clerk/astro/components";
import menuData from "../../config/menu.json";

const menuItems = menuData.main;
---

<header class="bg-blue-200 text-black rounded-2xl shadow-md">
  <div class="container mx-auto px-5 py-4">
    <div class="flex items-center justify-between">
      <!-- Selector de Empresa -->
      <div class="flex items-center space-x-4">
        <div class="w-44">
          selecionar empresa:
          <EmpresaSelector client:load />
        </div>
      </div>

      <!-- Links Desktop -->
      <SignedIn>
        <ul class="hidden md:flex items-center space-x-8 font-semibold">
          {menuItems.map((item) => (
            item.hasChildren ? (
              <li class="relative group">
                <button class="hover:scale-105 transition cursor-pointer py-2">
                  {item.name}
                  <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <ul class="absolute left-0 top-full hidden group-hover:block bg-white shadow-lg rounded-lg py-2 min-w-[200px] z-50 -mt-1">
                  {item.children?.map((child) => (
                    <li>
                      <HeaderLink href={child.url} class="block px-4 py-2 hover:bg-blue-100 text-gray-700">
                        {child.name}
                      </HeaderLink>
                    </li>
                  ))}
                </ul>
              </li>
            ) : (
              <HeaderLink href={item.url} class="hover:scale-105 transition">
                {item.name}
              </HeaderLink>
            )
          ))}
        </ul>
      </SignedIn>

      <!-- Botón de cerrar sesión Desktop -->
      <div class="hidden md:flex items-center space-x-4">
        <UserButton
          afterSignOutUrl="/"
          showName
          appearance={{
            elements: {
              userButtonMenuItem__manageAccount: { display: "none" },
              userButtonMenuItem__addAccount: { display: "none" },
            },
          }}
        />
      </div>

      <!-- Botón Menú Móvil (Hamburguesa) -->
      <button
        id="menu-btn"
        class="md:hidden text-gray-700 focus:outline-none p-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-8 w-8"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
      </button>
    </div>

    <!-- Menú Móvil Desplegable -->
    <div
      id="mobile-menu"
      class="hidden flex-col mt-4 space-y-4 border-t border-blue-300 pt-4 md:hidden"
    >
      <SignedIn>
        <ul class="flex flex-col space-y-3 font-semibold text-center">
          {menuItems.map((item) => (
            item.hasChildren ? (
              <li class="block">
                <details class="group">
                  <summary class="cursor-pointer hover:text-blue-600 list-none">
                    {item.name} ▼
                  </summary>
                  <ul class="mt-2 pl-4 space-y-2">
                    {item.children?.map((child) => (
                      <li>
                        <HeaderLink href={child.url} class="block hover:text-blue-600 text-sm">
                          {child.name}
                        </HeaderLink>
                      </li>
                    ))}
                  </ul>
                </details>
              </li>
            ) : (
              <HeaderLink href={item.url} class="block hover:text-blue-600">
                {item.name}
              </HeaderLink>
            )
          ))}
        </ul>
        <!-- UserButton Móvil -->
        <div class="flex justify-center pt-2">
          <UserButton
            afterSignOutUrl="/"
            showName
            appearance={{
              elements: {
                userButtonMenuItem__manageAccount: { display: "none" },
                userButtonMenuItem__addAccount: { display: "none" },
              },
            }}
          />
        </div>
      </SignedIn>
    </div>
  </div>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dropdownButtons = document.querySelectorAll("[data-dropdown]");

    dropdownButtons.forEach((button) => {
      const parent = button.closest("li");
      const menu = parent?.querySelector(".dropdown-menu");

      // Toggle en mobile
      button.addEventListener("click", (e) => {
        if (window.innerWidth < 768) {
          e.preventDefault();
          menu?.classList.toggle("hidden");
        }
      });

      // Mantener abierto en desktop cuando el mouse está sobre el menú
      if (parent && menu) {
        let timeoutId: number;

        const show = () => {
          if (window.innerWidth >= 768) {
            clearTimeout(timeoutId);
            menu.classList.remove("hidden");
          }
        };

        const hide = () => {
          if (window.innerWidth >= 768) {
            timeoutId = window.setTimeout(() => {
              menu.classList.add("hidden");
            }, 100);
          }
        };

        parent.addEventListener("mouseenter", show);
        parent.addEventListener("mouseleave", hide);
        menu.addEventListener("mouseenter", show);
        menu.addEventListener("mouseleave", hide);
      }
    });
  });
</script>
